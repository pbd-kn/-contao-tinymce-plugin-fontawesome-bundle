debugger;
    // This is the json format of https://gist.github.com/anthonykozak/84e07a2cf8c27d3e5a8f181742ca293d
// https://use.fontawesome.com/releases/v6.0.0/js/all.js
// icon size   fa-2xs fa-xs fa-sm fa-lg fa-xl
// fa-1x fa-2x fa-3x fa-4x fa-5x fa-6x fa-7x fa-8x fa-9x fa-10x
// extra version 5 kann nur fa-spin und fa-pulse
// fa-beat fa-fade fa-beat-fade fa-bounce fa-flip fa-shake fa-spin fa-spin-reverse fa-spin-pulse (fa-spin-pulse fa-spin-reverse)
//var akttextcolor='black';           // bei Klick auf Farbbername
//const version = '5.12.0';             // darzustellende Version
var meta = [];                      // metadaten werdn dynamisch von fontawesom geholt
var translate = tinymce.util.I18n.translate;
const config = {
  textColor: 'black', 
  iconselected: false,
  iconLfnr: '0',
  iconType: 'fas',
  iconName: 'hourglass',  
  iconSize: 'fa-3x',
  iconSizeStyle: '3em',
  iconEffectClass: '',
  iconBorder: '',
}
const iconSizes =    ['fa-sm' ,'fa-lg','fa-2x','fa-3x','fa-5x','fa-7x','fa-10x'];
const iconSizesStyle=['.875em','1.33333em','2em'  ,'3em'  ,'5em'  ,'7em'  ,'10em'];

const selectedFilters = {      // globaler Speicher fuer selectierten Filter
  membership: "free",
  style: "",
  category: "",
  search: "",
};
var iconListGroups = [];
var iconCategories = [];

var CategorieOptions = [];                      // enthaelt das Optionfeld fuer die Listbox categorie
var iconList = [];                              // MetaData der Icons

/* fuellt die iconListGroups[categoryName] mit den zugehoerigen Icons
 */
function generateIconGroupList(memberShip) {
  //console.log('PBD generateIconGroupList len '+iconList.length)
  if (memberShip != 'Free') return;         // Derzeit nur Free
  // Sort the icons alphabetically
  iconList.sort(function(a, b) {
    if (a.id < b.id) { return -1; }
    if (a.id > b.id) { return 1; }
    return 0;
  });
  var categoryName;
  for (var i = 0; i < iconList.length; i++) {
    if (typeof iconList[i].search != "undefined") {
      for (var ii = 0; ii < iconList[i].search.length; ii++) {    // ueber alle categorien des Icons
        categoryName=iconList[i].search[ii].trim();
        /*
        categoryName = categoryName.replace(/^ (.)/g, function(match, group1) { // ist vor der categorie ein blank so wird die categorie groá geschreiben
          console.log('PBD generateIconGroupList replace match '+match+' group1 '+group1);
               return group1;
               return group1.toUpperCase();
            }); 
        */
        if (categoryName == 'link' || categoryName == 'length') {
          //debugger;
          continue;    // dies indices führen zu Fehlern. Warum
        }
        if (!Array.isArray(iconListGroups[categoryName])) {
            
          //console.log('PBD generateIconlist push to iconListGroups '+categoryName);
          iconListGroups[categoryName] = undefined;               // Neue Kategorie zur Sicherheit loeschen
          iconListGroups[categoryName] = [];                      // Neue Kategorie
          iconCategories.push(categoryName);
        }
        iconListGroups[categoryName].push(iconList[i]);    // icon zur categorie speichern
        //console.log('PBD generateIconlist icon push '+iconList[i].label+' to categorie '+categoryName+' [] '+iconCategories[categoryName]);
      }
    }
  }
  //console.log('PBD generateIconGroupList iconCategories len '+iconCategories.length+' groups len '+iconListGroups.length);
}
/*
 * sortiert die Categorien alphabetisch
 * und liefert das categorie Array fuer den Dialog zurueck
 */
function createCategorieOptions() {
  //console.log ('PBD createCategorieOptions');
  const res =[];
  res.push ({text:'---',value:''});
  var listgroups=iconListGroups;
  iconCategories.sort(function(a, b) {
    if (a.toLowerCase() < b.toLowerCase()) { return -1; }
    if (a.toLowerCase() > b.toLowerCase()) { return 1; }
    return 0;
  });
  for(var i=0;i<iconCategories.length;i++) {  
    cat=iconCategories[i];
    if ( iconListGroups[cat].length > 2 && cat.indexOf(" ") == -1)  {      // all + min 1 und ohne Blank
      res.push ({text:translate(cat),value:cat});
//console.log ('PBD createCategorieOptions '+cat+' iconListGroups len '+iconListGroups[cat].length);
    }
    
  }
//  console.log('PBD createCategorieOptions res len '+res.length);
  return res;
}



/*
 * zeigt die Auswahl der moeglichen Groessen an
 * config.iconType enth„lt fab / fas Aus data-iconType Attribute bei select s. function selectIcon
 * config.icinName die iconName
 * config.textcolor die ausgew„hlte Farbe
 */
function showSelectSize() {
  //console.log('PBD show Selected Size '+'" data-iconType="'+config.iconType+'" data-name="'+config.iconName+'"'+'" color="'+config.textColor+'"');
  col='black';       // defaultcolor
  if( typeof config.textColor === 'undefined' || config.textColor === null || config.textColor==''){
    col='black';    
  } else {
    col=config.textColor;    
  }
  
  let style ="";
  cl ='fas';
  if (config.iconType === 'fab') {
    style="font-family:\'Font Awesome 5 brands\'; font-weight: 400; font-size: 3em;";
    style="font-family:\'Font Awesome 5 brands\'; font-weight: 400; font-size: 1.4em;";
  } else {
    style="font-family:\'Font Awesome 5 Free\'; font-weight: 900; font-size: 3em;";
    style="font-family:\'Font Awesome 5 Free\'; font-weight: 900; font-size: 1.4em;";
  }
          style="Font Awesome Kit";
          style="";

  //console.log('PBD showSelectSize style '+style);
  gridHtml = '<div>';
  gridHtml += translate('select size')+'<br>';
  for (var i = 0; i < iconSizes.length; i++) { 
    sz=iconSizes[i];
    //console.log('PBD szst '+szst);
    gridHtml += '<i class="mce_fasizing ';
    gridHtml += config.iconType+' fa-'+config.iconName+' '+config.iconEffectClass+' '+config.iconBorder+' '+sz+' "';   // class ende
    gridHtml += ' data-icon-size="'+sz+'"';
    gridHtml += '></i>';
   } 
  gridHtml += '</div>';
  //console.log('PBD show Selected Size ende');
  return gridHtml;
}

/*
 * liefert das ausgewaehlte Icon mit denzugehoerigen optionen als String zurueck
 */
function getAweIcon(extraStyle='') { 
  style = '';
  if( typeof config.textColor === 'undefined' || config.textColor === null || config.textColor==''){
    style=' style="'+extraStyle+';"';
  } else {
    style=' style="'+extraStyle+'color: '+config.textColor+';"';    
  }
  //console.log('PBD  getAweIcon start '+config.iconType+' fa-'+config.iconName+' size '+config.iconSize+' style '+style);    
  ret = '<i class="'+config.iconType+' fa-'+config.iconName+' '+config.iconSize+' '+config.iconEffectClass+' '+config.iconBorder+'" '+style+'>&zwj;</i>';
  //console.log('PBD getAweIcon ende ret '+ret);    
  return ret;
}

/*
 * zeigt die die Vorschau an
 * config.iconType enth„lt fab / fas Aus data-iconType Attribute bei select s. function selectIcon
 * config.icinName die iconName
 * config.textcolor die ausgew„hlte Farbe
 */
function showVorschau() {
  //console.log('PBD showVorschau');
  let style ='color: '+config.textColor;
  cl ='fas';

  gridHtml = '<div>';


  gridHtml += '<i class="mce_fasizing '+config.iconType+' fa-'+config.iconName+' '+config.iconSize+' '+config.iconEffectClass+' '+config.iconBorder+' " data-icon-size="'+config.iconSize+'" style="'+style+'"></i>';
  gridHtml += '</div>';
  return gridHtml
}

tinymce.PluginManager.add('fontawesome', function(editor, url) {
  var font_awesome_metafile_version = editor.getParam('font_awesome_metafile_version');
  var font_awesome_metafile_data = editor.getParam('font_awesome_metafile_data');
  iconList=font_awesome_metafile_data;
  //console.log('font_awesome_path for fontawesome:'+font_awesome_path);
  //console.log('PBD iconlist length: '+iconList.length);                    // anzahl icons in der metaliste
  //console.log('PBD font_awesome_metafile_version for font_awesome_metafile_version: '+font_awesome_metafile_version);
  generateIconGroupList('Free');
  CategorieOptions = createCategorieOptions();

  var redial=false;                   // Kennzeichnng ob bei Tabwechsel ein redial durchgefhrt werden soll
  var mce_dialogApi;              // zwischenspeicher fr dialogapi
  var currentTab='tabIcons';                 // enthaelt den Namen des ktuellen Tabs (fuer Redial) notwendig 
  CategorieOptions.push ({text:'---',value:''});  // muss wohl sein, sonst funktioniert der erste Aufruf nicht
  var FullIconHtml="";                            // enthaelt den html-String fuer alle Icons




/* bearbeitet den geladen Html-code
 * wertet die Filter aus und setzt ber das style-Attribute das Icon sichtbar oder nicht
 */
function filterIconHtml () {
  var els = document.querySelectorAll(".mce-icon-cell");
  //console.log ('PBD filterIconHtml len mce-icon-cell els '+els.length);
  if (selectedFilters.category==='' && selectedFilters.style===''&& selectedFilters.search==='') {  // keine Filter alles anzeigen
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
        e.style.display = "block";
        e.classList.remove("position-off-screen");
    }
    return;
  }
  if (selectedFilters.category!=='' && selectedFilters.style===''&& selectedFilters.search==='') {  // nur categorie Filter
    //console.log ('PBD filterIconHtml select only category '+selectedFilters.category);
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
      var dataCategory=e.getAttribute("data-category");
      var grpdataIndex=e.getAttribute("data-id");
      icon = iconListGroups[dataCategory][grpdataIndex];
      if (icon.search.includes(selectedFilters.category)) {
        e.style.display = "block";
        e.classList.remove("position-off-screen");
      } else {
        e.style.display = "none";
        e.classList.add("position-off-screen");
      }
    }
    return;
  }
  if (selectedFilters.category=='' && selectedFilters.style!==''&& selectedFilters.search==='') {  // nur styles Filter
    //console.log ('PBD filterIconHtml select only style '+selectedFilters.style);
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
      //if (e.getAttribute("data-iconStyle")==selectedFilters.style) {
      if (e.getAttribute("data-iconStyle").includes(selectedFilters.style)) {
        nm=e.getAttribute("data-name");
        e.style.display = "block";
        e.classList.remove("position-off-screen");
      } else {
        e.style.display = "none";
        e.classList.add("position-off-screen");
      }
    }
    return;
  }
  if (selectedFilters.category==='' && selectedFilters.style===''&& selectedFilters.search!=='') {  // nur suche
    //console.log ('PBD filterIconHtml select only search '+selectedFilters.search);
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
      //dataId=e.getAttribute("data-id");
      var dataCategory=e.getAttribute("data-category");
      var grpdataIndex=e.getAttribute("data-id");
      icon = iconListGroups[dataCategory][grpdataIndex];
      arr=icon.search;
      for(var i1 = 0 ; i1<arr.length ; i1++) {
         if(arr[i1].includes(selectedFilters.search)) {
           e.style.display = "block";
           e.classList.remove("position-off-screen");
           break;
         } else {
           e.style.display = "none";
           e.classList.add("position-off-screen");
         }
      }
    }
    
    return;
  }
  if (selectedFilters.category!=='' && selectedFilters.style!==''&& selectedFilters.search==='') {  // category und style
    //console.log ('PBD filterIconHtml select category und style '+selectedFilters.category+' '+selectedFilters.style);
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
      var dataCategory=e.getAttribute("data-category");
      var grpdataIndex=e.getAttribute("data-id");
      icon = iconListGroups[dataCategory][grpdataIndex];
      if (icon.search.includes(selectedFilters.category) && e.getAttribute("data-iconStyle").includes(selectedFilters.style)) {
        e.style.display = "block";
        e.classList.remove("position-off-screen");
      } else {
        e.style.display = "none";
        e.classList.add("position-off-screen");
      }
    }
    return;
  }
  if (selectedFilters.category!=='' && selectedFilters.style===''&& selectedFilters.search!=='') {  // Category search
    //console.log ('PBD filterIconHtml select category search '+selectedFilters.category+' '+selectedFilters.search);
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
      var dataCategory=e.getAttribute("data-category");
      var grpdataIndex=e.getAttribute("data-id");
      icon = iconListGroups[dataCategory][grpdataIndex];
      arr=icon.search;
      if (icon.search.includes(selectedFilters.category)) {
        for(var i1 = 0 ; i1<arr.length ; i1++) {
         if(arr[i1].includes(selectedFilters.search)) {
           e.style.display = "block";
           e.classList.remove("position-off-screen");
           break;
         } else {
           e.style.display = "none";
           e.classList.add("position-off-screen");
         }
        }
      }
    }
    return;
  }
  if (selectedFilters.category==='' && selectedFilters.style!==''&& selectedFilters.search!=='') {  // style search
    //console.log ('PBD filterIconHtml select style search '+selectedFilters.style+' '+selectedFilters.search);
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
      var dataCategory=e.getAttribute("data-category");
      var grpdataIndex=e.getAttribute("data-id");
      icon = iconListGroups[dataCategory][grpdataIndex];
      arr=icon.search;
      if (e.getAttribute("data-iconStyle").includes(selectedFilters.style)) {
        for(var i1 = 0 ; i1<arr.length ; i1++) {
         if(arr[i1].includes(selectedFilters.search)) {
           e.style.display = "block";
           e.classList.remove("position-off-screen");
           break;
         } else {
           e.style.display = "none";
           e.classList.add("position-off-screen");
         }
        }
      }
    }
    return;
  }
  if (selectedFilters.category!=='' && selectedFilters.style!==''&& selectedFilters.search!=='') {  // category style search
    //console.log ('PBD filterIconHtml select category style search '+selectedFilters.category+' '+selectedFilters.style+' '+selectedFilters.search);
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
      var dataCategory=e.getAttribute("data-category");
      var grpdataIndex=e.getAttribute("data-id");
      icon = iconListGroups[dataCategory][grpdataIndex];
      arr=icon.search;
      if (icon.search.includes(selectedFilters.category) && e.getAttribute("data-iconStyle").includes(selectedFilters.style)) {
        for(var i1 = 0 ; i1<arr.length ; i1++) {
         if(arr[i1].includes(selectedFilters.search)) {
           e.style.display = "block";
           e.classList.remove("position-off-screen");
           break;
         } else {
           e.style.display = "none";
           e.classList.add("position-off-screen");
         }
        }
      }
    }
    return;
  }
}

// erzeugt dann Html-code der alle Icons enthaelt. geordnet nach categorien
function createFullIconHtml() {
  //console.log('PBD createFullIconHtml')
  var lfnr=-1;   // laufende Nummer zu identifikation der Icons ueber alle categorien
  
  /*
   * gibt die Icons zu einer Categorie aus
   */
  function groupHtml(categoriy, iconTitle) {
    //console.log('PBD groupHtml categoriy '+categoriy+' title '+iconTitle);
    var iconGroup = iconListGroups[categoriy];
    var x=-1;      // Zaehler icon pro Zeile
    if( typeof iconGroup === 'undefined') {
      console.log('PBD groupHtml iconGroup undefined');
      return '<div> Categoriy '+categoriy+' nicht vorhanden</div>'
    }
    var gridHtml="";
    var id;
    //gridHtml += '<div class="mce-fontawesome-panel-category">Categorie: '+categoriy+' Titel '+iconTitle+'</div>';
    gridHtml += '<div class="mce-fontawesome-panel-content">';
    //console.log('PBD groupHtml iconGroup.length '+iconGroup.length+' categoriy '+categoriy); 
    for (var y = 0; y < iconGroup.length; y++) {
      lfnr++;                // laufende Nummer innerhalb der Category
      x++;
      //console.log('PBD groupHtml iconGroup width '+width+' y '+y); 
      if (iconGroup[lfnr]) {   // Einzelnes Icon der Ausgabe
          //id = iconGroup[y * width + x].lfnr;
	      //id = id.replace('i:', '');    //    objectId aus json i.a i:xxx  i: entfernen wird als title verwendet
          id=iconGroup[lfnr].id;
          name = iconGroup[lfnr].label;
          let iconStyle = '';
          if (typeof iconGroup[lfnr].styles === 'undefined') {
          } else {
            iconStyle = iconGroup[lfnr].styles;
          } 
          let cl ='fas';
          let style="";
          if (iconStyle.includes('brands')) {
            cl='fab';
          } else {
            cl='fas';
          }
          style="";
          let title="Name:\t"+id+"\nCode:\t"+iconGroup[lfnr].unicode+"\n"+"family:\n";
          for (var i1 = 0; i1 < iconGroup[lfnr].family.length; i1++) {
            title += "\t"+iconGroup[lfnr].family[i1]+"\n";
          }
          title+="Categorie:\n";
          for (var i1 = 0; i1 < iconGroup[lfnr].search.length; i1++) {
            title += "\t"+iconGroup[lfnr].search[i1]+"\n";
          }
          //console.log('PBD groupHtml name '+name+' st '+st+' style '+style+ ' lfnr '+lfnr);							
          //console.log('PBD groupHtml name '+name+' lfnr '+lfnr);							
          gridHtml += '<div id="mceicon_'+lfnr+'" class="mce-icon-cell js-mce-fontawesome-insert" title="'+title+'" data-name="'+id+'" data-iconType="'+cl+'" data-id="'+lfnr+'" data-category="'+categoriy+'" data-iconStyle="'+iconStyle+'" >';
          gridHtml += '<i class="faclass '+cl+' fa-'+id+'" style="'+style+'"></i>';
          gridHtml += '</div>';
        }
    }  // end Schleife categorie.length
    gridHtml += '<div style="clear:both"></div>';  // bendet den float:left und startet eine neue Zeile
    gridHtml += '</div>';  // mce-fontawesome-panel-content pro categorie
    return gridHtml;
  }  // ende function groupHtml
  var width = 23;   // Anzahl Icons pro Zeile
  let panelHtml="";
  panelHtml += groupHtml('all', translate('all'));
  return panelHtml;                      

}

function selectIcon(lfnr) {
  //console.log('PBD selectIcon icon '+lfnr)
  var els = document.querySelectorAll(".mce-icon-cell");
  if (els.length !=0 ) {
    //console.log('PBD selectIcon icon lfnr '+lfnr+' len seliccon '+els.length)
    for (var i = 0; i < els.length; i++) {
      var e = els[i];
      e.style.display = "none";
    }
    document.getElementById('mceicon_'+lfnr).classList.add("selectedIcon");                 // setze Object als selected
    config.iconType=document.getElementById('mceicon_'+lfnr).getAttribute("data-iconType");   // fas, fab ..
    config.iconName=document.getElementById('mceicon_'+lfnr).getAttribute("data-name");  // name ohne fa-
    config.iconLfnr=document.getElementById('mceicon_'+lfnr).getAttribute("data-id");          // laufende nummer
    config.iconselected = true;
    //console.log('PBD selectIcon setting class '+config.iconType+' name '+config.iconName+' lfnr '+config.iconLfnr)
    mce_dialogApi.redial(getdialogConfig());
    mce_dialogApi.showTab("tabColor");
  }
}

/*
 * speichert die groesse des selectierten icons und setzt den border dazu
 */
function selectIconSize(size) {
  config.iconSize = size;
  var els = document.querySelectorAll(".mce_fasizing");
  // search the fontsize for mce
  for (var i=0;i<iconSizes.length;i++) {
    if (config.iconSize == iconSizes[i]) {
      config.iconSizeStyle = iconSizesStyle[i];                    // merke die Groesse fr die mce Darstellung in Vorschau
      break;
    } 
  }
  //console.log('PBD selectIconSize size '+config.iconSize+ ' els len '+els.length);
  
  for (var i = 0; i < els.length; i++) {   // alle Border loeschen
    var e = els[i];
    e.style.border = "2px solid #ffffff";
  }
  //console.log ('PBD selector '+".mce_fasizing." + size);
  els = document.querySelectorAll(".mce_fasizing." + size);
  //console.log('PBD selectIconSize size '+config.iconSize+ ' els1 len '+els.length);
  for (var i = 0; i < els.length; i++) {
    var e = els[i];
    e.style.border = "2px solid #207ab7";     // border setzen
  }
}


function getdialogConfig(){
  return {
    title: 'Fontawesome Icons',
    size: 'large',
    body: {
      type: 'tabpanel',
      tabs: [
        { name: 'tabIcons', title: 'Icons '+font_awesome_metafile_version,                                   
          items: [ 
            {  type: "bar",items: [
                 { type: 'selectbox', name: 'freeSelect',label: 'Lizenz',disabled: false, size: 1, 
                     items: [
                        { value: 'free', text: 'Free' },
                        //{ value: 'pro', text: 'Pro' }    bei Pro weiss ich nicht was tun
                     ]
                 },  
                 {  type: 'listbox', name: 'selectStyle',label: 'SelectStyle',disabled: false, 
                      items: [
                        { text: '---', value: '' },
                        { text: 'Regular', value: 'regular' },
                        { text: 'Solid', value: 'solid' },
                        { text: 'Brand', value: 'brands' },
                     ],
                 },                
                 { type: 'listbox', name: 'selectCategorie', label: translate('DisplayCategory'),disabled: false, items: CategorieOptions }, 
                 { type: 'input', name: 'searchIcon',inputMode: 'text',label: 'SearchIcon', disabled: false,maximized: false},                
               ],   // ende bar items
            },
/*            { type: 'textarea', // component type
              name: 'infotabIcons', // identifier
              label: translate('SelectedFilters'),
              placeholder: 'example',
              disabled: true, // disabled state
              maximized: false // grow width to take as much space as possible
            },
*/
            { type: 'htmlpanel', html: FullIconHtml },
          ]
        },           // ende tabIcons
        { name: 'tabColor', title: 'Icon Konfiguration',
          items: [        // Elemente des Tab Formulars
            { type: "bar",items: [
                { type: 'listbox',name: 'selectEffectTab',label: 'Effect',disabled: false,
                     items: [
                       { text: '---', value: '' },
                       { text: 'Spin', value: 'fa-spin' },
                       { text: 'Spin Reverse', value: 'fa-spin fa-spin-reverse' },
                       { text: 'Pulse', value: 'fa-pulse' },
                       { text: 'Beat', value: 'fa-beat' },
                       { text: 'Beat Fade', value: 'fa-beat-fade' },
                       { text: 'Bounce', value: 'fa-bounce' },
                       { text: 'Fade', value: 'fa-fade' },
                       { text: 'Flip', value: 'fa-flip' },
                       { text: 'Shake', value: 'fa-shake' },                    
                     ],
                },
                { type: 'listbox',name: 'selectBorder',label: 'Border',disabled: false,
                     items: [
                       { text: 'Off', value: '' },
                       { text: 'On', value: 'fa-border' },
                     ],
                },                     
              ],
            },
/*            { type: 'textarea', // component type
              name: 'infotabColor', // identifier
              label: translate('SelectedFilters'),
              placeholder: 'example',
              disabled: true, // disabled state
              maximized: false // grow width to take as much space as possible
            },
*/
            { type: 'htmlpanel', html: showSelectSize() },
            { type: 'label', label: translate('select color'), items: [{ type: "colorpicker", name: "mce_colorpicker" }] },
              // extra version 5 kann nur fa-spin und fa-pulse
              // fa-beat fa-fade fa-beat-fade fa-bounce fa-flip fa-shake fa-spin fa-spin-reverse fa-spin-pulse (fa-spin-pulse fa-spin-reverse)
          ],         // ende tabColor Items
        },           // ende tabColor 
        { name: 'tabVorschau', title: 'Vorschau',
          items: [        // Elemente des Formulars
            { type: 'htmlpanel', html: '<div style="color:'+'inherit'+'">Vorschau</div>'},          
            { type: 'htmlpanel', html: showVorschau() }, 
          ]         
        },           // ende tabVorschau
      ] // ende tabs
    },
    buttons: [  // footer Buttons
      { type: 'submit', name: 'submitButton', buttonType: 'primary', text: translate('submitButton'), },
      { type: 'cancel', name: 'closeButton', text: translate('cancelButton'), },
    ],
    initialData: { },
    onSubmit: (api) => {
      res=getAweIcon();
      //console.log ('PBD submit '+res);
      if (!tinymce.activeEditor.execCommand('mceInsertContent', false,res)){
        console.log('!!! Fehler bei submit');
      }
      api.close();
    },
    onAction: (dialogApi, details) => {     // wird gerufen u.a bei button click
      // log the contents of details
      const data = dialogApi.getData();
      const v=data.mce_colorpicker; // get hexWert from colorpicker 
    },
    onChange: function (dialogApi, details) {
      var data = dialogApi.getData();
      var nm = details.name;
      //console.log ('PBD onchange nm '+nm);
      switch (nm) {
        case 'selectCategorie':
          var val = data.selectCategorie;
          //console.log ('PBD selectCategorie nm '+nm+'  wert '+val+' old '+selectedFilters.category);
          selectedFilters.category = val; 
          filterIconHtml();
          dialogApi.setData({ selectCategorie: selectedFilters.category })
//          dialogApi.setData({ infotabColor: 'style: '+selectedFilters.style+' category: '+selectedFilters.category})
//          dialogApi.setData({ infotabIcons: 'style: '+selectedFilters.style+' category: '+selectedFilters.category})          
        break;
        
        case 'selectStyle':
          var val = data.selectStyle;
          //console.log ('PBD selectStyle nm '+nm+'  wert '+val+' old '+selectedFilters.style);
          selectedFilters.style = val; 
          filterIconHtml();
          dialogApi.setData({ selectStyle: selectedFilters.style })
//          dialogApi.setData({ infotabColor: 'style: '+selectedFilters.style+' category: '+selectedFilters.category})
//          dialogApi.setData({ infotabIcons: 'style: '+selectedFilters.style+' category: '+selectedFilters.category})          
        break;
        case 'searchIcon':
          var val = data.searchIcon;
          //console.log ('PBD searchIcon nm '+nm+'  wert '+val);
          selectedFilters.search = val; 
          filterIconHtml();
        break;
        case 'selectEffectTab':        
          var val = data.selectEffectTab;
          //console.log ('PBD selectEffectTab nm '+nm+'  wert '+val+' old '+config.iconEffectClass);
          config.iconEffectClass = val;
          mce_dialogApi.redial(getdialogConfig());
          mce_dialogApi.showTab("tabColor");
          mce_dialogApi.setData({ selectEffectTab: config.iconEffectClass })
          break;
        case 'selectBorder':
          var val = data.selectBorder;
          //console.log ('PBD selectBorder nm '+nm+'  wert '+val);
          config.iconBorder = val;
          mce_dialogApi.redial(getdialogConfig());
          mce_dialogApi.showTab("tabColor");
          mce_dialogApi.setData({ selectBorder: config.iconBorder })
          break;
        
        default:
          //console.log ('PBD onChange was '+nm);
        break;
        
      }
    },
  
    onTabChange: (dialogApi, details) => {
      const data = mce_dialogApi.getData();
      //console.log('PBD onTabChange newname '+details.newTabName+' oldname '+details.oldTabName+' redial '+redial+' color '+config.textColor);
      //console.log('PBD onTabChange setting group '+config.iconType+' name '+config.iconName);
      
      if (details.newTabName == "tabIcons") {
        // default setzen
        config.textColor='black'; 
        config.iconselected=false;
        config.iconLfnr='0';
        config.iconType='fas';
        config.iconName='hourglass';  
        config.iconSize='fa-3x';
        config.iconSizeStyle='3em';
        //config.iconEffectClass='';
        //config.iconBorder='';
        selectedFilters.membership="free";
        selectedFilters.style="";
        selectedFilters.category="";
        selectedFilters.search="";

        dialogApi.setData({ selectCategorie: selectedFilters.category })
        dialogApi.setData({ selectStyle: selectedFilters.style })
        dialogApi.setData({ searchIcon: selectedFilters.search })
        
        dialogApi.setData({ selectEffectTab: config.iconEffectClass })
        dialogApi.setData({ selectBorder: config.iconBorder })

//        dialogApi.setData({ infotabIcons: 'style: '+selectedFilters.style+' category: '+selectedFilters.category})
//        dialogApi.setData({ infotabColor: 'style: '+selectedFilters.style+' category: '+selectedFilters.category})        
      }
      

      if (details.newTabName == "tabColor") {
        //console.log('PBD onTabChange tabcolor color'+config.textColor);
        var els = document.querySelectorAll(".mce_fasizing");        // gib alle Elemente  mit der Groessenangabe
        //console.log('PBD tabColor len fasing '+els.length+' color '+config.textColor);
        for (var i = 0; i < els.length; i++) {                       // setze Farbe
          var e = els[i];
          e.style.color = config.textColor;
        }
        redial=true;
      } else if (details.newTabName == "tabVorschau") {
        if (redial == true) {
          redial=false;
          mce_dialogApi.redial(getdialogConfig());
          mce_dialogApi.showTab("tabVorschau");
        }
      }
    },
  };
}
function initListener() {
  // Insert icon listener 
  //console.log('PBD initListener');
  document.addEventListener("click", function (e) {
    //console.log("PBD click function");
    if (e.target.parentElement.classList.contains("js-mce-fontawesome-insert")) {   //check auf icon select Auswahl
      //console.log("PBD click function1 icon selected");
      selectIcon(e.target.parentElement.getAttribute("data-id"));                //??? mste das icht die id, d.h laufende nummer sein
    } else if (e.target.parentElement.parentElement.classList.contains("js-mce-fontawesome-insert")) {
      //console.log("PBD click function2 icon selected");
      selectIcon(e.target.parentElement.parentElement.getAttribute("data-id"));
    }
    if (e.target.classList.contains("mce_fasizing")) {
      //console.log("PBD click function3 size selected");
      selectIconSize(e.target.getAttribute("data-icon-size"));           // check auf Groessenauswahl
    } else if (e.target.parentElement.classList.contains("mce_fasizing")) {
      //console.log("PBD click function4 size selected");
      selectIconSize(e.target.parentElement.getAttribute("data-icon-size"));           // check auf Groessenauswahl
    }
    if (e.target.classList.contains("tox-sv-palette") || e.target.classList.contains("tox-hue-slider")) {
      //console.log("PBD click function5");
      var dataX = mce_dialogApi.getData();
      config.textColor=dataX.mce_colorpicker;        
      mce_dialogApi.setData({ mce_colorpicker: config.textColor });
      var els = document.querySelectorAll(".mce_fasizing");      // Elemente Gr”áe
      //console.log("PBD click function4 len "+els.length+' color '+config.textColor);
      for (var i = 0; i < els.length; i++) {         // gr”áenicon einf„rben
        var e = els[i];
        e.style.color = config.textColor;
      }
    }
  });

  document.addEventListener("change", function (e) {
    if (e.target.classList.contains("fai_pickerColorInput")) {
      var dataX = mce_dialogApi.getData();
      var els = document.querySelectorAll("mce_fasizing");
      for (var i = 0; i < els.length; i++) {
        var e = els[i];
        e.style.color = dataX.mce_colorpicker;
      }
    }
  });  
}

function initMe(editor) {
  //console.log ('PBDinitMe ');

// initilisierungsRoutinen bevor der Manager aufgerufen wird


  mce_dialogApi = editor.windowManager.open(getdialogConfig());
  mce_dialogApi.block("Loading...");

  FullIconHtml=createFullIconHtml();          // html aller icons icons erzeugen
  mce_dialogApi.redial(getdialogConfig());
  mce_dialogApi.unblock();
  
  initListener();
}
    // Include plugin CSS
    editor.on('init', function() {
        var csslink = editor.dom.create('link', {
            rel: 'stylesheet',
            href: url + '/css/mce-panel.css'
        });
        document.getElementsByTagName('head')[0].appendChild(csslink);
       
        //console.log("PBD editor.on linkcss "+url + '/css/mce-panel.css ');
    });

  /* Add a button that opens a window */
  editor.ui.registry.addIcon('fontaweIcon', '<svg fill="none" height="24" width="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 860 860"><path d="M763.634 0H96.366C43.576 0 0 43.576 0 96.366v667.268C0 816.424 43.576 860 96.366 860h667.268c52.79 0 96.366-43.576 96.366-96.366V96.366C860 43.576 816.424 0 763.634 0zm-87.152 545.754c0 8.063-6.911 11.518-14.973 14.974-32.058 13.821-66.42 26.299-103.277 26.299-51.638 0-75.634-32.058-137.638-32.058-44.728 0-91.759 16.125-129.576 33.21-2.304 1.151-4.607 1.151-6.911 2.303v87.152c0 3.455 0 6.911-1.152 9.214v2.304c-4.607 16.125-19.58 27.451-36.665 27.451-21.692 0-38.969-17.277-38.969-38.969V258c-14.973-11.518-25.147-29.754-25.147-50.487 0-35.513 28.603-64.308 64.308-64.308 35.514 0 64.308 28.603 64.308 64.308 0 20.733-9.214 38.969-25.147 50.487v35.513c3.455-1.151 6.911-2.303 10.366-4.607 35.513-14.973 77.937-27.451 118.058-27.451 43.576 0 77.937 11.518 116.906 26.299 8.063 3.456 16.125 4.608 25.148 4.608 43.575 0 91.759-30.907 103.276-30.907 9.215 0 17.277 6.911 17.277 14.974v269.325z" fill="#339af0"/></svg>');   // PBD
  editor.ui.registry.addButton('fontawesome', {
        //icon: 'flag',
        icon: 'fontaweIcon',
        //text: translate('Fontawesome'),
        tooltip: translate('Fontawesome'),
        onAction: function () { initMe(editor);} 
  });


    editor.ui.registry.addMenuItem('fontawesome', {
        icon: 'fontaweIcon',
        text: translate('Fontawesome'),
        tooltip: translate('Fontawesome'),
        onclick: function () { initMe(editor);}, 
        onAction: 'insert'
    });

});  // ende tinymce.PluginManager.add
tinymce.PluginManager.requireLangPack('fontawesome');


